<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="error.pirate.backend.quotation.query.mapper.QuotationMapper">

    <!--  견적서 목록 조회  -->
    <select id="selectQuotationList" resultType="error.pirate.backend.quotation.query.dto.QuotationListItemDTO">
        SELECT
            tb_quotation.quotation_seq,
            tb_quotation.quotation_name,
            (SELECT
                GROUP_CONCAT(tb_item.item_name SEPARATOR ", ")
            FROM tb_quotation_item
            JOIN tb_item USING (item_seq)
            WHERE tb_quotation.quotation_seq = tb_quotation_item.quotation_seq) AS item_name,
            tb_client.client_name,
            tb_quotation.quotation_quotation_date,
            tb_quotation.quotation_status
        FROM tb_quotation
        JOIN tb_client USING (client_seq)
        WHERE TRUE
        <if test="startDate != null"><![CDATA[
            AND #{startDate} <= tb_quotation.quotation_quotation_date
        ]]></if>
        <if test="endDate != null"><![CDATA[
            AND #{endDate} >= tb_quotation.quotation_quotation_date
        ]]></if>
        <if test="clientName != null">
            AND tb_client.client_name LIKE CONCAT('%', #{clientName}, '%')
        </if>
        <if test="quotationStatus != null">
            AND tb_quotation.quotation_status LIKE #{quotationStatus}
        </if>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!--  견적서 목록 개수 조회  -->
    <select id="countQuotationList" resultType="int">
        SELECT
            COUNT(*)
        FROM tb_quotation
        JOIN tb_client USING (client_seq)
        WHERE TRUE
        <if test="startDate != null"><![CDATA[
            AND #{startDate} <= tb_quotation.quotation_quotation_date
        ]]></if>
        <if test="endDate != null"><![CDATA[
            AND #{endDate} >= tb_quotation.quotation_quotation_date
        ]]></if>
        <if test="clientName != null">
            AND tb_client.client_name LIKE CONCAT('%', #{clientName}, '%')
        </if>
        <if test="quotationStatus != null">
            AND tb_quotation.quotation_status LIKE #{quotationStatus}
        </if>
    </select>

    <!--  견적서 상세 조회  -->
    <select id="selectQuotation" resultType="error.pirate.backend.quotation.query.dto.QuotationDTO">
        SELECT
            tb_quotation.quotation_seq,
            tb_quotation.quotation_name,
            tb_client.client_name,
            tb_quotation.quotation_extended_price,
            tb_quotation.quotation_total_quantity,
            tb_user.user_name,
            tb_quotation.quotation_quotation_date,
            tb_quotation.quotation_effective_date,
            tb_quotation.quotation_note
        FROM tb_quotation
        JOIN tb_user USING (user_seq)
        JOIN tb_client USING (client_seq)
        WHERE tb_quotation.quotation_seq = #{quotationSeq}
    </select>

    <!--  견적서 상세 품목 조회  -->
    <select id="selectQuotationItem" resultType="error.pirate.backend.quotation.query.dto.QuotationItemDTO">
        SELECT
            tb_quotation_item.quotation_item_seq,
            tb_quotation_item.item_seq,
            tb_item.item_image_url,
            tb_item.item_division,
            tb_item.item_name,
            tb_quotation_item.quotation_item_quantity,
            tb_quotation_item.quotation_item_price,
            tb_quotation_item.quotation_item_note
        FROM tb_quotation_item
        JOIN tb_item USING (item_seq)
        WHERE tb_quotation_item.quotation_seq = #{quotationSeq}
    </select>

</mapper>
